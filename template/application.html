<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ system_name }} DHCP</title>
    <script language="javascript">
        var PASSWD_LENGTH = '{{ passwd_length }}',
            PASSWD_ALPHA = '{{ passwd_alpha }}',
            PASSWD_NUMBER = '{{ passwd_number }}',
            PASSWD_SPECIAL = '{{ passwd_special }}';
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="zen, zensystems, zensystems.co.kr, bigdata, pci, admin">
    <meta name="author" content="Zenssytems">
    <meta name="keyword" content="zen, zensystems, zensystems.co.kr, bigdata, pci, admin">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="stylesheet" href="/static/resources/js/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/resources/js/bootstrap-theme.min.css"/>

    <script type="text/javascript" src="/static/resources/js/CryptoJS/rollups/sha512.js"></script>
    <script type="text/javascript" src="/static/resources/js/CryptoJS/rollups/md5.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 -->
    <!--[if lt IE 9]>
    <script src="/static/login/js/html5shiv.js"></script>
    <script src="/static/login/js/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="/static/resources/js/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="/static/resources/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/static/resources/js/bootstrap.min.js"></script>

    <!--검증중 화면전환효과-->
    <meta http-equiv="Page-Enter" content="blendTrans(Duration=2)">
    <META http-equiv="Page-Enter" CONTENT="RevealTrans(Duration=1, Transition=24)">
    <script language="javascript">
        $(document).ready(function () {
            $('#successModal').on('hidden', function () {
                if(!$("#userID").val()){$("#userID").focus();return;}
                if(!$("#passwd").val()){$("#passwd").focus();return;}
                if(!$("#passwd2").val()){$("#passwd2").focus();return;}
                if(!$("#name").val()){$("#name").focus();return;}
                if(!$("#phone").val()){$("#phone").focus();return;}
                if(!$("#email").val()){$("#email").focus();return;}
                if(!$("#depart").val()){$("#depart").focus();return;}
                if(!$("#desc").val()){$("#desc").focus();return;}
            })
        });

        function joinOnKeyDown(){
            var keyCode = event.keyCode;
             if(keyCode == 13)
             {
                  join();
             }
        }

        function closeWindow() {
            window.close()
        }

        function modalShow(message) {
            $('#alert-form-message').text(message);
            $('#successModal').modal()
        }

        function join(){
            var csrf = $('#csrfmiddlewaretoken').val(),
                    userID = $("#userID").val(),
                    password = $("#passwd").val(),
                    password2 = $("#passwd2").val(),
                    name = $("#name").val(),
                    email = $("#email").val(),
                    tel = $("#phone").val(),
                    depart = $("#depart").val(),
                    desc = $("#desc").val();

            if(!userID) {modalShow('사용자 ID를 입력하세요.'); return false;}
            if(!password) {modalShow('암호를 입력하세요.'); return false;}
            if(password!=password2) {modalShow('암호 확이이 다릅니다.'); return false;}
            if(!name) {modalShow('이름을 입력하세요.'); return false;}
            if(!tel) {modalShow('휴대전화를 입력하세요.'); return false;}
            if(!email) {modalShow('이메일을 입력하세요.'); return false;}
            if(!depart) {modalShow('부서를 입력하세요.'); return false;}
            if(!desc) {modalShow('신청사유를 입력하세요.'); return false;}

            function check_passwd(passwd, PASSWD_LENGTH, PASSWD_ALPHA, PASSWD_NUMBER, PASSWD_SPECIAL) {
                var ALPHA = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var NUMBER = '1234567890';
                var SPECIAL = '!@#$%^&*()-_+=[]{}';

                function charByteSize(ch) {
                    if(ch == null || ch.length == 0) {
                        return 0;
                    }

                    var charCode = ch.charCodeAt(0);

                    if(charCode<=0x00007F) {
                        return 1;
                    } else if(charCode<=0x0007FF) {
                        return 2;
                    } else if(charCode<=0x00FFFF) {
                        return 3;
                    } else {
                        return 4;
                    }
                }
                function stringByteSize(str) {
                    if(str == null || str.length == 0) {
                        return 0;
                    }

                    var size = 0;
                    for(var i = 0; i<str.length; i++) {
                        size += charByteSize(str.charAt(i));
                    }
                    return size;
                }

                if(stringByteSize(passwd)>16) {
                    return {error: 'TOOLENGTH'};
                }

                if(PASSWD_LENGTH>passwd.length) {
                    return {error: 'LENGTH'};
                }

                var types = [];
                if(PASSWD_ALPHA == 'on') {
                    types.push(ALPHA);
                }
                if(PASSWD_NUMBER == 'on') {
                    types.push(NUMBER);
                }
                if(PASSWD_SPECIAL == 'on') {
                    types.push(SPECIAL);
                }

                for(var i = 0; i<types.length; i++) {
                    var found = false;
                    for(var j = 0; j<passwd.length; j++) {
                        if(types[i].indexOf(passwd.charAt(j))> -1) {
                            found = true;
                            break;
                        }
                    }

                    if(!found) {
                        if(types[i] == ALPHA) {
                            return {error: 'ALPHA'}
                        } else if(types[i] == NUMBER) {
                            return {error: 'NUMBER'}
                        } else if(types[i] == SPECIAL) {
                            return {error: 'SPECIAL'}
                        }
                    }
                }

                return {error: ''};
            }

            var pw_ret = check_passwd(password, PASSWD_LENGTH, PASSWD_ALPHA, PASSWD_NUMBER, PASSWD_SPECIAL);
            if (pw_ret.error && password.length != 0) {
                if (pw_ret.error == 'LENGTH') {
                    alert("비밀번호를 " + PASSWD_LENGTH + "자리 이상 입력해주세요.");
                } else if (pw_ret.error == 'ALPHA' || pw_ret.error == 'NUMBER' || pw_ret.error == 'SPECIAL') {
                    var buf = '비밀번호를';
                    if (PASSWD_ALPHA == 'on') {
                        buf += ' 알파벳';
                    }
                    if (PASSWD_NUMBER == 'on') {
                        if (buf != '비밀번호를') {
                            buf += ', 숫자';
                        } else {
                            buf += ' 숫자';
                        }
                    }
                    if (PASSWD_SPECIAL == 'on') {
                        if (buf != '비밀번호를') {
                            buf += ', 특수문자';
                        } else {
                            buf += ' 특수문자';
                        }
                    }
                    alert(buf + " (을)를 포함한 문자열로 입력해주세요");
                }
                return;
            }

            $.ajax({
                url: '/application/create',
                type: "POST",
                data: {
                    userID: userID,
                    passwd: CryptoJS.SHA512(password).toString(),
                    name: name,
                    email: email,
                    phone: tel,
                    depart: depart,
                    desc: desc,
                    status: 0,
                    csrfmiddlewaretoken: csrf
                },
                success: function (data, textStatus, jqXHR) {
                    if(data.success) {
                        $('#finishModal').modal();
                        //closeWindow();
                    } else if(data.success === false){
                        modalShow('생성 실패 :' + data.msg);
                        return false;
                    } else {
                        modalShow('서버와 네트워크 상태 이상');
                        return false;
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    modalShow('서버와 네트워크 상태 이상');
                }
            });
        }
    </script>
</head>
<body>
<div class="join-header">
    <div class="col-md-12 join-header-title text-center">{{ system_name }} ID 생성</div>
</div>
<div class="join-body">
    <div class="col-md-12">
        <form id="join-form" method="POST">
            <input type="hidden" id="csrfmiddlewaretoken" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <input type="hidden" id="salt" name="salt" value="{{ salt }}">
            <div class="form-group">
                <label for="joinInputEmail">사용자 ID</label>
                <input id="userID" name="userID" type="text" class="form-control" placeholder="사용자 ID" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputPassword">암호</label>
                <input id="passwd" name="passwd" type="password" class="form-control" placeholder="암호" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputPassword">암호 확인</label>
                <input id="passwd2" name="passwd2" type="password" class="form-control" placeholder="암호" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputName">사용자 이름</label>
                <input id="name" name="name" type="text" class="form-control" placeholder="사용자 이름" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputEmail">휴대전화</label>
                <input id="phone" name="phone" type="tel" class="form-control" placeholder="휴대전화" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputEmail">메일</label>
                <input id="email" name="email" type="email" class="form-control" placeholder="이메일" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputEmail">부서</label>
                <input id="depart" name="depart" type="text" class="form-control" placeholder="부서" onKeyDown="joinOnKeyDown();">
            </div>
            <div class="form-group">
                <label for="joinInputEmail">신청사유</label>
                <input id="desc" name="desc" type="text" class="form-control" placeholder="신청사유" onKeyDown="joinOnKeyDown();">
            </div>
        </form>
    </div>
</div>
<div class="join-footer">
    <div class="text-center"  class="col-md-12">
        <button type="button" class="btn btn-default" style="max-width: 160px; min-width: 100px; width: 40%" onclick="join();">등록</button>
        <button type="button" class="btn btn-default" style="max-width: 160px; min-width: 100px; width: 40%" data-toggle="modal" data-target="#cancelModal">취소</button>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="cancelModalLabel">알림</h4>
      </div>
      <div class="modal-body">
        계정 발급을 취소 하시겠습니까?
      </div>
      <div class="text-center">
        <button type="button" class="btn btn-default" data-dismiss="modal">입력 계속</button>
        <button type="button" class="btn btn-primary" onclick="closeWindow();">취소 (창 닫기)</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="finishModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="successModalLabel">알림</h4>
      </div>
      <div class="modal-body">
        계정 발급 신청이 완료 되었습니다. 관리자 승인 후 로그인이 가능합니다.
      </div>
      <div class="text-center">
        <button type="button" class="btn btn-primary" onclick="closeWindow();">확인</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true" style="overflow: hidden">
    <div class="join-form">
        <div class="row" style="margin: 0px">
            <div class="col-md-4 col-md-offset-4">
                <div class="row">
                    <div class="join-header-dark">
                        <div class="col-md-2"></div>
                        <div class="col-md-8 join-header-title text-center">알람</div>
                        <div class="col-md-2"></div>
                    </div>
                    <div class="join-body-small">
                        <div class="col-md-1"></div>
                        <div class="col-md-10">
                            <div id="alert-form-message" class="form-group"></div>
                        </div>
                        <div class="col-md-1"></div>
                    </div>
                    <div class="join-footer-dark">
                        <div class="text-center">
                            <button type="button" class="btn btn-default" data-dismiss="modal">확인</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>